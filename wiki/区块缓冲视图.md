# 区块缓冲视图

## 缓冲区设计

在一个区块被确认后，使用该区块的时间戳在间隔一定区块（缓冲区大小）后的时间，进行区块的打包

<img src="https://imgs.decision01.com/Chronos%20%E8%AE%BE%E8%AE%A1%20-%20%E5%8C%BA%E5%9D%97%E7%BC%93%E5%86%B2%E5%8C%BA.jpg" alt="Chronos 设计 - 区块缓冲区" style="zoom: 25%;" />

下面是缓冲区的树形结构的一个示意图，**在实际的场景下每一层不会出现这么多区块**

<img src="https://imgs.decision01.com/image-20230316000811659.png" alt="image-20230316000811659" style="zoom:15%;" />

每一次打包区块的时候，选取树形结构的最优叶子节点作为前一个区块进行区块的打包

区块打包时选取当前视图下的最优区块进行选取

> 最优区块的选取方法：从已确认区块开始进行广度优先搜索，根据时间戳和交易数量确认优先级后得到当前视图下的最优区块
>
> （这里其实可以进行优化，在插入区块到缓冲区的同时进行处理，**单独用一个类来处理？**）

对缓冲区的功能要求（缓冲树？）

1. 保存在当前视图下的每个高度的最优区块
2. 每次处理一个区块的时候，如果这个区块的前一个区块的哈希值在本地存在，就添加到树中，否则加入到第二队列，第二队列每30s或其他延时处理这个区块
3. 可以通过一个方法一次性获取到所有缓冲树下的区块，便于将区块头发给对端节点，这里同步器 `Syncer` 的逻辑还需要设计

**存在的一个问题，这里都假设所有节点的都是会按照最优的路径更新最新区块，那么，如何保证恶意节点中途插入交易量较大的区块的时候能改识别出来并且将恶意区块排除？**缓冲区设计

在一个区块被确认后，使用该区块的时间戳在间隔一定区块（缓冲区大小）后的时间，进行区块的打包

<img src="https://imgs.decision01.com/Chronos%20%E8%AE%BE%E8%AE%A1%20-%20%E5%8C%BA%E5%9D%97%E7%BC%93%E5%86%B2%E5%8C%BA.jpg" alt="Chronos 设计 - 区块缓冲区" style="zoom: 25%;" />

下面是缓冲区的树形结构的一个示意图，**在实际的场景下每一层不会出现这么多区块**

<img src="https://imgs.decision01.com/image-20230316000811659.png" alt="image-20230316000811659" style="zoom:15%;" />

每一次打包区块的时候，选取树形结构的最优叶子节点作为前一个区块进行区块的打包

区块打包时选取当前视图下的最优区块进行选取

> 最优区块的选取方法：从已确认区块开始进行广度优先搜索，根据时间戳和交易数量确认优先级后得到当前视图下的最优区块
>
> （这里其实可以进行优化，在插入区块到缓冲区的同时进行处理，**单独用一个类来处理？**）

对缓冲区的功能要求（缓冲树？）

1. 保存在当前视图下的每个高度的最优区块
2. 每次处理一个区块的时候，如果这个区块的前一个区块的哈希值在本地存在，就添加到树中，否则加入到第二队列，第二队列每30s或其他延时处理这个区块
3. 可以通过一个方法一次性获取到所有缓冲树下的区块，便于将区块头发给对端节点，这里同步器 `Syncer` 的逻辑还需要设计

**存在的一个问题，这里都假设所有节点的都是会按照最优的路径更新最新区块，那么，如何保证恶意节点中途插入交易量较大的区块的时候能改识别出来并且将恶意区块排除？**